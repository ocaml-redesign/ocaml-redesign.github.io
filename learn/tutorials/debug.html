<!DOCTYPE HTML>

<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title> &ndash; OCaml</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Web Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Domine:400,700" rel="stylesheet">
    <!-- Only part of Bootstrap that we don't load from a CDN is our own customized CSS build. -->
    <link href="/static/css/bootstrap.css" rel="stylesheet" media="screen">
    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/"><img src="/static/img/ocaml.png" alt="OCaml"></a>
          <div class="nav-collapse collapse">
                        <ul class="nav">
              <li ><a href="/learn/">Learn</a></li>
              <li ><a href="/docs/">Documentation</a></li>
              <li ><a href="/platform/">Platform</a></li>
              <li ><a href="/list.html">Packages</a></li>
              <li ><a href="/community/">Community</a></li>
            </ul>

            <form class="navbar-search pull-right">
              <input class="search-query" type="text" placeholder="Search" />
            </form>
          </div>
        </div>
      </div>
    </nav>
    
        <div class="container">
      <div class="row">

        <div class="span4">
          <nav id="nav-secondary">
            <ul class="nav nav-list">
              <li class="nav-header"><a href="#">Contents</a></li>
<ul>
 <li><a href='#Tracingfunctionscallsinthetoplevel'> Tracing functions calls in the toplevel</a>
  <ul>
   <li><a href='#Polymorphicfunction'> Polymorphic function</a>
   </li>
   <li><a href='#Limitations'> Limitations</a>
   </li>
  </ul>
 </li>
 <li><a href='#TheOCamldebugger'> The OCaml debugger</a>
  <ul>
   <li><a href='#Launchingthedebugger'> Launching the debugger</a>
   </li>
   <li><a href='#Findingthecauseofaspuriousexception'> Finding the cause of a spurious exception</a>
   </li>
   <li><a href='#Gettinghelpandinfointhedebugger'> Getting help and info in the debugger</a>
   </li>
   <li><a href='#Settingbreakpoints'> Setting break points</a>
   </li>
   <li><a href='#UsingthedebuggerunderXEmacs'> Using the debugger under (X)Emacs</a>
   </li>
  </ul>
 </li>
</ul>

            </ul>
          </nav>
        </div>
        <div id="content-primary" class="span8">
          <div class="content">
            
<h1 id="Debugging"> Debugging</h1><p>
This note quickly presents two techniques to debug OCaml programs:</p>
<ul>
 <li><a href='#trace'>Tracing functions calls</a>that works in the toplevel,
 </li>
 <li><a href='#ocamldebug'>OCaml debugger</a>, which allows analysing programes
 compiled with <code>ocamlc</code>.</li>
</ul>

<h2 id="Tracingfunctionscallsinthetoplevel"> Tracing functions calls in the toplevel</h2><p>
The simplest way to debug programs in the toplevel is to follow the
function calls, by “tracing” the faulty function:</p>
<pre><code class='ocaml'>  <span class='k'>let rec</span> fib x <span class='k'>=</span> <span class='k'>if</span> x <span class='o'>&#60;=</span> 1 <span class='k'>then</span> 1 <span class='k'>else</span> fib (x <span class='o'>-</span> 1) <span class='o'>+</span> fib (x <span class='o'>-</span> 2)<span class='o'>;;</span>
<span class='o'>#</span> <span class='o'>#</span>trace fib<span class='o'>;;</span>
fib is now traced<span class='o'>.</span>
<span class='o'>#</span> fib 3<span class='o'>;;</span>
fib <span class='o'>&#60;--</span> 3
fib <span class='o'>&#60;--</span> 1
fib <span class='o'>--&#62;</span> 1
fib <span class='o'>&#60;--</span> 2
fib <span class='o'>&#60;--</span> 0
fib <span class='o'>--&#62;</span> 1
fib <span class='o'>&#60;--</span> 1
fib <span class='o'>--&#62;</span> 1
fib <span class='o'>--&#62;</span> 2
fib <span class='o'>--&#62;</span> 3
<span class='o'>-</span> <span class='o'>:</span> int <span class='k'>=</span> 3
<span class='o'>#</span> <span class='o'>#</span>untrace fib<span class='o'>;;</span>
fib is no longer traced<span class='o'>.</span>
</code></pre>
<h3 id="Polymorphicfunction"> Polymorphic function</h3><p>

A difficulty with polymorphic functions is that the output of the trace
system is not very informative in case of polymorphic arguments and/or
results. Consider a sorting algorithm (say bubble sort):</p>
<pre><code class='ocaml'>  <span class='k'>let</span> exchange i j v <span class='k'>=</span>
    <span class='k'>let</span> aux <span class='k'>=</span> v<span class='o'>.</span>(i) <span class='k'>in</span>
    v<span class='o'>.</span>(i) <span class='o'>&#60;-</span> v<span class='o'>.</span>(j)<span class='o'>;</span> v<span class='o'>.</span>(j) <span class='o'>&#60;-</span> aux<span class='o'>;;</span>
  
  <span class='k'>let</span> one_pass_vect fin v <span class='k'>=</span>
    <span class='k'>for</span> j <span class='k'>=</span> 1 <span class='k'>to</span> fin <span class='k'>do</span>
      <span class='k'>if</span> v<span class='o'>.</span>(j <span class='o'>-</span> 1) <span class='o'>&#62;</span> v<span class='o'>.</span>(j) <span class='k'>then</span> exchange (j <span class='o'>-</span> 1) j v
    <span class='k'>done</span><span class='o'>;;</span>
  
  <span class='k'>let</span> bubble_sort_vect v <span class='k'>=</span>
    <span class='k'>for</span> i <span class='k'>=</span> <span class='m'>Array</span><span class='o'>.</span>length v <span class='o'>-</span> 1 <span class='k'>downto</span> 0 <span class='k'>do</span>
    one_pass_vect i v
  <span class='k'>done</span><span class='o'>;;</span>

  <span class='k'>let</span> q <span class='k'>=</span> <span class='o'>[</span><span class='o'>|</span> 18<span class='o'>;</span> 3<span class='o'>;</span> 1 <span class='o'>|</span><span class='o'>]</span><span class='o'>;;</span>

<span class='o'>#</span> <span class='o'>#</span>trace one_pass_vect<span class='o'>;;</span>
one_pass_vect is now traced<span class='o'>.</span>
<span class='o'>#</span> bubble_sort_vect q<span class='o'>;;</span>
one_pass_vect <span class='o'>&#60;--</span> 2
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
one_pass_vect <span class='o'>&#60;--</span> 1
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
one_pass_vect <span class='o'>&#60;--</span> 0
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;;</span> <span class='o'>&#60;</span>poly<span class='o'>&#62;|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
<span class='o'>-</span> <span class='o'>:</span> unit <span class='k'>=</span> ()
</code></pre>
<p>
The function <code>one_pass_vect</code> being polymorphic, its vector argument is
printed as a vector containing polymorphic values,
<code>[|&lt;poly&gt;; &lt;poly&gt;;           &lt;poly&gt;|]</code>, and thus we cannot properly
follow the computation.</p>
<p>A simple way to overcome this problem is to define a monomorphic version
of the faulty function. This is fairly easy using a <em>type constraint</em>.
Generally speaking, this allows a proper understanding of the error in
the definition of the polymorphic function. Once this has been
corrected, you just have to suppress the type constraint to revert to a
polymorphic version of the function. For our sorting routine, a single
type constraint on the argument of the <code>exchange</code> function warranties a
monomorphic typing, that allows a proper trace of function calls:</p>
<pre><code class='ocaml'><span class='o'>#</span> <span class='k'>let</span> exchange i j (v <span class='o'>:</span> int vect) <span class='k'>=</span>
    <span class='o'>[</span><span class='o'>...</span><span class='o'>]</span>
exchange <span class='o'>:</span> int <span class='k'>-></span> int <span class='k'>-></span> int vect <span class='k'>-></span> unit <span class='k'>=</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
    <span class='o'>[</span><span class='o'>...</span><span class='o'>]</span>
one_pass_vect <span class='o'>:</span> int <span class='k'>-></span> int vect <span class='k'>-></span> unit <span class='k'>=</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
    <span class='o'>[</span><span class='o'>...</span><span class='o'>]</span>
bubble_sort_vect <span class='o'>:</span> int vect <span class='k'>-></span> unit <span class='k'>=</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
<span class='o'>#</span> <span class='o'>#</span>trace one_pass_vect<span class='o'>;;</span>
one_pass_vect is now traced<span class='o'>.</span>
<span class='o'>#</span> <span class='k'>let</span> q <span class='k'>=</span> <span class='o'>[</span><span class='o'>|</span> 18<span class='o'>;</span> 3<span class='o'>;</span> 1 <span class='o'>|</span><span class='o'>]</span><span class='o'>;;</span>
q <span class='o'>:</span> int vect <span class='k'>=</span> <span class='o'>[</span><span class='o'>|</span>18<span class='o'>;</span> 3<span class='o'>;</span> 1<span class='o'>|</span><span class='o'>]</span>
<span class='o'>#</span> bubble_sort_vect q<span class='o'>;;</span>
one_pass_vect <span class='o'>&#60;--</span> 2
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|</span>18<span class='o'>;</span> 3<span class='o'>;</span> 1<span class='o'>|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
one_pass_vect <span class='o'>&#60;--</span> 1
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|</span>3<span class='o'>;</span> 1<span class='o'>;</span> 18<span class='o'>|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
one_pass_vect <span class='o'>&#60;--</span> 0
one_pass_vect <span class='o'>--&#62;</span> <span class='o'>&#60;</span><span class='k'>fun</span><span class='o'>&#62;</span>
one_pass_vect<span class='o'>*</span> <span class='o'>&#60;--</span> <span class='o'>[</span><span class='o'>|</span>1<span class='o'>;</span> 3<span class='o'>;</span> 18<span class='o'>|</span><span class='o'>]</span>
one_pass_vect<span class='o'>*</span> <span class='o'>--&#62;</span> ()
<span class='o'>-</span> <span class='o'>:</span> unit <span class='k'>=</span> ()
</code></pre>
<h3 id="Limitations"> Limitations</h3><p>

To keep track of assignments to data structures and mutable variables in
a program, the trace facility is not powerful enough. You need an extra
mechanism to stop the program in any place and ask for internal values:
that is a symbolic debugger with its stepping feature.</p>
<p>Stepping a functional program has a meaning which is a bit weird to
define and understand. Let me say that we use the notion of <em>runtime
events</em> that happen for instance when a parameter is passed to a
function or when entering a pattern matching, or selecting a clause in a
pttern matching. Computation progress is taken into account by these
events, independantly of the instructions executed on the hardware.</p>
<p>Although this is difficult to implement, there exists such a debugger
for OCaml under Unix: <code>ocamldebug</code> (there also exists one for Caml
Light, as a user contribution). Its use is illustrated in the next
section.</p>
<p>In fact, for complex programs, it is likely the case that the programmer
will use explicit printing to find the bugs, since this methodology
allows the reduction of the trace material : only useful data are
printed and special purpose formats are more suited to get the relevant
information, than what can be output automatically by the generic
pretty-printer used by the trace mechanism.</p>
<h2 id="TheOCamldebugger"> The OCaml debugger</h2><p>
We now give a quick tutorial for the OCaml debugger (<code>ocamldebug</code>).
Before starting, please note that <code>ocamldebug</code> does not work under
native Windows ports of OCaml (but it runs under the Cygwin port.</p>
<h3 id="Launchingthedebugger"> Launching the debugger</h3><p>
Consider the following obviously wrong program written in the file
<code>uncaught.ml</code>:</p>
<pre><code class='ocaml'><span class='com2'>(* file uncaught<span class='ic'>.</span>ml *)</span><!-- end comment -->
<span class='k'>let</span> l <span class='k'>=</span> ref <span class='o'>[</span><span class='o'>]</span><span class='o'>;;</span>
<span class='k'>let</span> find_address name <span class='k'>=</span> <span class='m'>List</span><span class='o'>.</span>assoc name <span class='o'>!</span>l<span class='o'>;;</span>
<span class='k'>let</span> add_address name address <span class='k'>=</span> l <span class='o'>:=</span> (name<span class='o'>,</span> address) <span class='o'>::</span> <span class='o'>!</span> l<span class='o'>;;</span>
add_address <span class='s'>&#34;IRIA&#34;</span> <span class='s'>&#34;Rocquencourt&#34;</span><span class='o'>;;</span>
print_string (find_address <span class='s'>&#34;INRIA&#34;</span>)<span class='o'>;</span> print_newline ()<span class='o'>;;</span>
</code></pre>
<p>
At runtime, the program raises an uncaught exception <code>Not_found</code>.
Suppose we want to find where and why this exception has been raised, we
can proceed as follows:</p>
<ol>
 <li>we compile the program in debug mode:<br /></li>
</ol>

<pre><code class='ocaml'>ocamlc <span class='o'>-</span>g uncaught<span class='o'>.</span>ml
</code></pre>
<ol>
 <li>we launch the debugger:</li>
</ol>

<pre><code class='ocaml'>ocamldebug a<span class='o'>.</span>out
</code></pre>
<p>Then the debugger answers with a banner and a prompt:</p>
<pre><code class='ocaml'>        OCaml Debugger version 4.00<span class='o'>.</span>1

(ocd)
</code></pre>
<h3 id="Findingthecauseofaspuriousexception"> Finding the cause of a spurious exception</h3><p>

Type <code>r</code> (for <em>run</em>); you get</p>
<pre><code class='ocaml'>(ocd) r
Loading program<span class='o'>...</span> <span class='k'>done</span><span class='o'>.</span>
Time <span class='o'>:</span> 12
Program <span class='k'>end</span><span class='o'>.</span>
Uncaught <span class='k'>exception</span><span class='o'>:</span> Not_found
(ocd)
</code></pre>
<p>
Self explanatory, is&#39;nt it? So, you want to step backward to set the
program counter before the time the exception is raised; hence type in
<code>b</code> as <em>backstep</em>, and you get</p>
<pre><code class='ocaml'>(ocd) b
Time <span class='o'>:</span> 11 <span class='o'>-</span> pc <span class='o'>:</span> 15500 <span class='o'>-</span> <span class='k'>module</span> List
143     <span class='o'>[</span><span class='o'>]</span> <span class='k'>-></span> <span class='o'>&#60;|</span>b<span class='o'>|&#62;</span>raise Not_found
</code></pre>
<p>
The debugger tells you that you are in module <code>List</code>, inside a pattern
matching on a list that already chose the <code>[]</code> case and is about to
execute <code>raise Not_found</code>, since the program is stopped just before this
expression (as witnessed by the <code>&lt;|b|&gt;</code> mark).</p>
<p>But, as you know, you want the debugger to tell you which procedure
calls the one from <code>List</code>, and also who calls the procedure that calls
the one from <code>List</code>; hence, you want a backtrace of the execution stack:</p>
<pre><code class='ocaml'>(ocd) bt
<span class='o'>#</span>0  Pc <span class='o'>:</span> 15500  List char 3562
<span class='o'>#</span>1  Pc <span class='o'>:</span> 19128  Uncaught char 221
</code></pre>
<p>
So the last function called is from module <code>List</code> at character 3562,
that is :</p>
<pre><code class='ocaml'><span class='k'>let rec</span> assoc x <span class='k'>=</span> <span class='k'>function</span>
    <span class='o'>[</span><span class='o'>]</span> <span class='k'>-></span> raise Not_found
          <span class='o'>^</span>
  <span class='o'>|</span> (a<span class='o'>,</span>b)<span class='o'>::</span>l <span class='k'>-></span> <span class='k'>if</span> a <span class='k'>=</span> x <span class='k'>then</span> b <span class='k'>else</span> assoc x l
</code></pre>
<p>
The function that calls it is in module <code>Uncaught</code>, file <code>uncaught.ml</code>
char 221:</p>
<pre><code class='ocaml'>print_string (find_address <span class='s'>&#34;INRIA&#34;</span>)<span class='o'>;</span> print_newline ()<span class='o'>;;</span>
                                  <span class='o'>^</span>
</code></pre>
<p>
To sum up: if you&#39;re developping a program you can compile it with the
<code>-g</code> option, to be ready to debug the program if necessary. Hence, to
find a spurious exception you just need to type <code>ocamldebug a.out</code>, then
<code>r</code>, <code>b</code>, and <code>bt</code> gives you the backtrace.</p>
<h3 id="Gettinghelpandinfointhedebugger"> Getting help and info in the debugger</h3><p>
To get more info about the current status of the debugger you can ask it
directly at the toplevel prompt of the debugger; for instance:</p>
<pre><code class='ocaml'>(ocd) info breakpoints
No breakpoint<span class='o'>.</span>

(ocd) help break
  1      15396  <span class='k'>in</span> List<span class='o'>,</span> character 3539
break <span class='o'>:</span> Set breakpoint at specified line <span class='k'>or</span> <span class='k'>function</span><span class='o'>.</span>
Syntax<span class='o'>:</span> break <span class='k'>function</span><span class='o'>-</span>name
break <span class='o'>@</span> <span class='o'>[</span><span class='k'>module</span><span class='o'>]</span> linenum
break <span class='o'>@</span> <span class='o'>[</span><span class='k'>module</span><span class='o'>]</span> <span class='o'>#</span> characternum
</code></pre>
<h3 id="Settingbreakpoints"> Setting break points</h3><p>

Let&#39;s set up a breakpoint and rerun the entire program from the
beginning (<code>(g)oto 0</code> then <code>(r)un</code>):</p>
<pre><code class='ocaml'>(ocd) break <span class='o'>@</span>Uncaught 9
Breakpoint 3 at 19112 <span class='o'>:</span> file Uncaught<span class='o'>,</span> line 9 column 34

(ocd) g 0
Time <span class='o'>:</span> 0
Beginning <span class='k'>of</span> program<span class='o'>.</span>

(ocd) r
Time <span class='o'>:</span> 6 <span class='o'>-</span> pc <span class='o'>:</span> 19112 <span class='o'>-</span> <span class='k'>module</span> Uncaught
Breakpoint <span class='o'>:</span> 1
9 add <span class='s'>&#34;IRIA&#34;</span> <span class='s'>&#34;Rocquencourt&#34;</span><span class='o'>&#60;|</span>a<span class='o'>|&#62;;;</span>
</code></pre>
<p>
Then, we can step and find what happens when <code>find_address</code> is about to
be called</p>
<pre><code class='ocaml'>(ocd) s
Time <span class='o'>:</span> 7 <span class='o'>-</span> pc <span class='o'>:</span> 19012 <span class='o'>-</span> <span class='k'>module</span> Uncaught
5 <span class='k'>let</span> find_address name <span class='k'>=</span> <span class='o'>&#60;|</span>b<span class='o'>|&#62;</span><span class='m'>List</span><span class='o'>.</span>assoc name <span class='o'>!</span>l<span class='o'>;;</span>

(ocd) p name
name <span class='o'>:</span> string <span class='k'>=</span> <span class='s'>&#34;INRIA&#34;</span>

(ocd) p <span class='o'>!</span>l
<span class='o'>$</span>1 <span class='o'>:</span> (string <span class='o'>*</span> string) list <span class='k'>=</span> <span class='o'>[</span><span class='s'>&#34;IRIA&#34;</span><span class='o'>,</span> <span class='s'>&#34;Rocquencourt&#34;</span><span class='o'>]</span>
(ocd)
</code></pre>
<p>
Now we can guess why <code>List.assoc</code> will fail to find &quot;INRIA&quot; in the
list...</p>
<h3 id="UsingthedebuggerunderXEmacs"> Using the debugger under (X)Emacs</h3><p>
Note also that under Emacs you call the debugger using <code>ESC-x</code>
<code>camldebug a.out</code>. Then Emacs will set you directly to the file and
character reported by the debugger, and you can step back and forth
using <code>ESC-b</code> and <code>ESC-s</code>, you can set up break points using
<code>CTRL-X       space</code>, and so on...</p>

          </div>
        </div>
      </div>
    </div>
    <footer id="footer" class="navbar navbar-inverse navbar-fixed-bottom">
      <div class="navbar-inner">
        <div class="container-fluid">
          <ul class="nav pull-right">
            <li><a href="#">Feedback</a></li>
            <li><a href="#">Contact us</a></li>
            <li><a href="#">Find us on GitHub</a></li>
          </ul>
        </div>
      </div>
    </footer>
    <!-- Load javascript from CDN -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
  </body>
</html>
