<!DOCTYPE HTML>

<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title> &ndash; OCaml</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Web Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Domine:400,700" rel="stylesheet">
    <!-- Only part of Bootstrap that we don't load from a CDN is our own customized CSS build. -->
    <link href="/static/css/bootstrap.css" rel="stylesheet" media="screen">
    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/"><img src="/static/img/ocaml.png" alt="OCaml"></a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li ><a href="/learn/">Learn</a></li>
              <li ><a href="/docs/">Documentation</a></li>
              <li ><a href="/platform.html">Platform</a></li>
              <li ><a href="/menu.html">Packages</a></li>
              <li ><a href="/community/">Community</a></li>
            </ul>
            <form class="navbar-search pull-right">
              <input class="search-query" type="text" placeholder="Search" />
            </form>
          </div>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">

        <div id="content-primary" class="span8">
          <div class="content">
            <p><em>Table des matières</em></p>
<h1 id="UtiliserlemoduleFormat">Utiliser le module Format</h1>
<p>Le module Format des librairies standard de Caml Light et OCaml propose
une méthode d&apos;impression enjolivée. Ce module implémente un moteur
d&apos;impression qui coupe « bien » les lignes (« bien » signifie à-peu-près
ici « automatiquement et quand nécessaire »).</p>
<h2 id="Principes">Principes</h2>
<p>La coupure des lignes repose sur trois concepts:</p>

 <ul>
  <li><p><strong>Les boîtes</strong> : une boîte est une unité logique d&apos;impression, qui
 définit un comportement du moteur d&apos;impression pour présenter
 l&apos;intérieur de la boîte.</p>
</li>
  <li><p><strong>Les indications de coupures</strong> : une indication de coupure est une
 directive au moteur d&apos;impression, qui lui propose de couper la ligne
 à cet endroit si cela s&apos;avère nécessaire. Sinon, le moteur
 d&apos;impression ne coupe jamais les lignes (sauf en « cas d&apos;urgence »
 pour éviter les trop mauvaises sorties).</p>
</li>
  <li><p><strong>Les règles d&apos;indentation</strong> : Quand le moteur d&apos;impression démarre
 une nouvelle ligne, il fixe l&apos;indentation de la nouvelle ligne
 (c&apos;est-à-dire le nombre de blancs insérés en début de ligne) en
 suivant des règles qui dépendent à la fois de l&apos;indication de
 coupure et de la définition de la boîte où la ligne est coupée :</p>

   <ul>
    <li><p>Une boîte peut définir le montant de l&apos;indentation ajoutée à
 chaque nouvelle ligne de son corps. Cette valeur est appelée
 <strong>indentation additionnelle de boîte</strong>.</p>
</li>
    <li><p>Une indication de coupure peut aussi définir une indentation
 additionelle pour la nouvelle ligne qu&apos;elle peut occasionner.
 Cette valeur est appelée <strong>indentation additionnelle de coupure</strong>.</p>
</li>
    <li><p>Si l&apos;indication de coupure <code>bh</code> engendre une nouvelle ligne à
 l&apos;intérieur de la boîte <code>b</code>, alors l&apos;indentation de la nouvelle
 ligne est la somme de: l&apos;indentation courante de la boîte <code>b</code>
 <code>+</code> l&apos;indentation additionnelle de boîte définie par la boîte
 <code>b</code> <code>+</code> l&apos;indication additionnelle de coupure définie par
 l&apos;indication de coupure <code>bh</code>.</p>
</li>
   </ul>
</li>
 </ul>

<h2 id="Lesbotes">Les boîtes</h2>
<p>Il y a 4 types de boîtes. (La plus communément utilisée est la boîte «
hov », laissez tomber les autres types en première lecture.)</p>

 <ul>
  <li><p><strong>Boîte horizontale</strong> (boîte <em>h</em>, ouverte par la procédure
 <code>open_hbox</code>) : dans cette boîte les indications de coupures ne
 donnent pas lieu à retour à la ligne.</p>
</li>
  <li><p><strong>Boîte verticale</strong> (boîte <em>v</em>, ouverte par la procédure
 <code>open_vbox</code>): toute indication de coupure provoque un retour à la
 ligne.</p>
</li>
  <li><p><strong>Boîte verticale/horizontale</strong> (boîte <em>hv</em>, ouverte par la
 procédure <code>open_hvbox</code>) : si c&apos;est possible, toute la boîte est
 imprimée sur une seule ligne; sinon toute indication de coupure
 provoque un retour à la ligne.</p>
</li>
  <li><p><strong>Boîte verticale ou horizontale</strong> (boîte <em>hov</em>, ouverte par l&apos;une
 des procédures <code>open_box</code> ou <code>open_hovbox</code>) ou boîte « tassante »:
 les indications de coupure sont utilisées pour aller à la ligne
 quand il n&apos;y a plus de place sur la ligne courante. Il existe deux
 espèces légèrement différentes de boîtes « hov » qui sont décrites
 <a href='#hov-boxes'>plus bas</a>. En première approximation nous confondrons
 ces deux types de boîtes « hov » et ne considérerons que celles
 obtenues avec la procédure <code>open_box</code>.</p>
<p>Donnons un exemple. Supposons que nous voulions écrire 10 caractères
avant la marge droite (qui indique qu&apos;il n&apos;y a plus de place sur la
ligne courante). Je représente chaque caractère par une marque <code>-</code>, les
ouvertures et fermetures de boîtes sont indiquées respectivement par <code>[</code>
et <code>]</code>, et <code>b</code> signifie une indication de coupure (blanc ou « break »).</p>
<p>La sortie &quot;--b--b--&quot; est imprimée comme suit (le symbole b vaut la
valeur de la coupure comme expliqué ci-après) :</p>
</li>
  <li><p>dans une boîte « h » :
</p>
<pre><code>   --b--b</code></pre>
</li>
  <li><p>dans une boîte « v » :
</p>
<pre><code>   --b
   --b
   </code></pre>
</li>
  <li><p>dans une boîte « hv » :
S&apos;il y a assez de place pour imprimer toute la boîte sur la ligne 
</p>
<pre><code>   --b--b</code></pre>
<p>
Mais si &quot;---b---b---&quot; ne peut tenir sur la ligne, la sortie 
</p>
<pre><code>   ---b
   ---b
   </code></pre>
</li>
  <li><p>dans une boîte « hov » :
S&apos;il y a assez de place pour imprimer toute la boîte sur la ligne 
</p>
<pre><code>   --b--b</code></pre>
<p>
Mais si &quot;---b---b---&quot; ne peut tenir sur la ligne, la sortie 
</p>
<pre><code>   ---b---b
   </code></pre>
<p>
La première indication de coupure ne donne pas lieu à un retour à la
ligne, puisque la ligne n&apos;est pas pleine. La seconde indication de
coupure entraîne un retour à la ligne, puisqu&apos;il n&apos;y a plus la place
d&apos;imprimer ce qui suit l&apos;indication de coupure. Si la place restante
sur la ligne était encore plus courte, la première indication de
coupure aurait aussi donné lieu à un retour à la ligne et
&quot;---b---b---&quot; aurait été imprimé ainsi
</p>
<pre><code>    ---b
    ---b
    </code></pre>
</li>
 </ul>

<h2 id="Impressiondesespaces">Impression des espaces</h2>
<p>Les indications de coupure sont aussi utilisées pour imprimer des
espaces (si la ligne n&apos;est pas coupée quand l&apos;indication de coupure est
traitée, sinon le retour à la ligne sépare correctement les éléments à
imprimer). Vous donnez une indication de coupure en appelant
<code>print_break sp indent</code>, où <code>sp</code> est l&apos;entier qui indique le nombre
d&apos;espaces à imprimer.  
 Donc <code>print_break sp ...</code> signifie imprimer <code>sp</code> espaces ou aller à la
ligne.</p>
<p>Par exemple, si l&apos;on imprime &quot;--b--b--&quot; (où <code>b</code> est <code>print_break 1 0</code>,
ce qui correspond à l&apos;impression d&apos;un espace), on obtient la sortie
suivante :</p>

 <ul>
  <li><p>dans une boîte « h » :
</p>
<pre><code>   -- -- </code></pre>
</li>
  <li><p>dans une boîte « v » :
</p>
<pre><code>   --
   --
   </code></pre>
</li>
  <li><p>dans une boîte « hv » :
</p>
<pre><code>   -- -- </code></pre>
<p>
ou, suivant la place restante sur la ligne 
</p>
<pre><code>   --
   --
   </code></pre>
</li>
  <li><p>et de même pour les boîtes « hov ».</p>
<p>De façon générale, un programme qui utilise <code>format</code>, n&apos;écrit pas
d&apos;espaces lui-même mais émet des indications de coupure. (Par exemple à
l&apos;aide de <code>print_space ()</code> qui est synonyme de <code>print_break     1 0</code> et
écrit un espace ou déclenche une coupure de ligne.)</p>
</li>
 </ul>

<h2 id="Indentationdeslignesnouvelles">Indentation des lignes nouvelles</h2>
<p>On dispose de deux moyens de fixer l&apos;indentation des lignes :</p>

 <ul>
  <li><p><strong>En définissant la boîte où la ligne apparaît</strong>: à l&apos;ouverture de
 la boîte, on peut fixer l&apos;indentation ajoutée à chaque ligne ouverte
 dans la boîte.  
 Par exemple: <code>open_hovbox 1</code> ouvre une boîte hovbox dont les lignes
 seront indentées de 1 par rapport à l&apos;indentation initiale de la
 boîte. Ainsi avec &quot;---[--b--b--b--&quot;, on obtient :
</p>
<pre><code>   ---[--b--b
        --b</code></pre>
<p>
tandis qu&apos;avec <code>open_hovbox 2</code>, on obtient 
</p>
<pre><code>   ---[--b--b
         --b</code></pre>
<p>
Note: le symbole <code>[</code> n&apos;est évidemment pas visible sur la sortie
écran, je l&apos;écris pour matérialiser l&apos;ouverture de la boîte
d&apos;impression. Ainsi le dernier « écran » est en fait 
</p>
<pre><code>    -----b--b
         --b</code></pre>
</li>
  <li><p>En définissant l&apos;indication de coupure qui a provoqué le retour à la
 ligne. On émet une indication de coupure avec
 <code>print_break sp indent</code>. L&apos;entier <code>indent</code> fixe l&apos;indentation
 additionnelle de la nouvelle ligne qui peut être émise par
 l&apos;indication de coupure. C&apos;est-à-dire que <code>indent</code> est ajouté à
 l&apos;indentation par défaut de la boîte où la coupure a lieu.   
 Par exemple, en indiquant par <code>[</code> l&apos;ouverture d&apos;une boîte <code>hov 1</code>
 (obtenue par <code>open_hovbox       1</code>), et par <code>b</code>
 <code>print_break       1       2</code>, alors la sortie de &quot;---[--b--b--b--&quot;,
 sera imprimée :
</p>
<pre><code>   ---[-- --
         --
         </code></pre>
</li>
 </ul>

<h2 id="Raffinementsurlesboteshov">Raffinement sur les boîtes « hov »</h2>
<h3 id="Botehovtassanteetbotehovstructurelle"> Boîte « hov » tassante et boîte « hov » structurelle</h3>
<p>Les boîtes « hov » se subdivisent en deux catégories au comportement
légèrement différent en ce qui concerne les coupures qui interviennent
après la fermeture d&apos;une boîte dont l&apos;indentation est différente de la
boîte qui l&apos;englobe. On distingue :</p>

 <ul>
  <li><p>**la boîte « hov » *tassante*** (ouverte par la procédure
 <code>open_hovbox</code>): les indications de coupure sont utilisées pour aller
 à la ligne quand il n&apos;y a plus de place sur la ligne courante; il
 n&apos;y a pas de passage à la ligne s&apos;il y a assez de place sur la ligne
 courante.</p>
</li>
  <li><p>**la boîte « hov » *structurelle*** (ouverte par la procédure
 <code>open_box</code>): très similaire à la boîte « hov » tassante, les
 indications de coupure sont également utilisées pour aller à la
 ligne quand il n&apos;y a plus de place sur la ligne courante, mais de
 surcroît les indications de coupures qui permettent de mettre en
 évidence la structure de boîtes sont effectuées même s&apos;il reste
 assez de place sur la ligne courante.</p>
</li>
 </ul>

<h3 id="Diffrencesentrebotehovtassanteetbotehovstructurelle"> Différences entre boîte « hov » tassante et boîte « hov » structurelle</h3>
<p>La différence de comportement entre la boîte « hov » tassante et la
boîte « hov » structurelle (ou « box ») est mise en évidence par la
fermeture des boîtes et la fermeture des parenthèses en fin
d&apos;impression: avec la boîte « hov » tassante les boîtes et les
parenthèses sont fermées sur la même ligne (si la place disponible le
permet), tandis qu&apos;avec la boîte « hov » structurelle chaque indication
de coupure produira un saut de ligne. Prenons l&apos;exemple de la sortie de
&quot;[(---[(----[(---b)]b)]b)]&quot; où &quot;b&quot; représente une indication de coupure
sans indentation supplémentaire (<code>print_cut     ()</code>). Ainsi, si &quot;[&quot;
représente l&apos;ouverture de boîtes « hov » tassantes (<code>open_hovbox</code>),
&quot;[(---[(----[(---b)]b)]b)]&quot; est imprimé ainsi:</p>
<pre><code>(---
 (----
  (---)))</code></pre>
<p>Si maintenant on remplace les boîtes « hov » tassantes par des boîtes «
hov » structurelles (<code>open_box</code>), chaque indication de coupure placée
avant chaque parenthèse fermante est susceptible de montrer la structure
de boîte et produit donc une coupure; on obtient alors :</p>
<pre><code>(---
 (----
  (---
  )
 )
)</code></pre>
<h2 id="Conseilspratiques">Conseils pratiques</h2>
<p>En écrivant vos fonctions d&apos;impression, suivez les règles simples
suivantes :</p>

 <ol>
  <li><p>Les boîtes doivent être ouvertes et fermées de façon cohérente (les
 appels à <code>open_*</code> et à <code>close_box</code> doivent être parenthésés).</p>
</li>
  <li><p>N&apos;hésitez pas à ouvrir des boîtes.</p>
</li>
  <li><p>Donnez beaucoup d&apos;indications de coupures, sinon l&apos;imprimeur se
 retrouve dans une situation anormale (coincé sur la marge droite),
 où il essaie de faire de son mieux, ce qui n&apos;est pas toujours très
 bon.</p>
</li>
  <li><p>N&apos;essayez pas de forcer l&apos;espacement à l&apos;aide de blancs explicites
 dans les chaînes de caractères à imprimer. Pour chaque espace
 nécessaire, utilisez une indication de coupure (<code>print_space ()</code>), à
 moins que vous ne vouliez pas que la ligne soit coupée à cet
 endroit. Par exemple, imaginez que vous vouliez imprimer une
 définition OCaml, disons <code>let rec ident = expression</code>. Vous allez
 probablement considérer les 3 premiers blancs comme des « blancs
 insécables » et les inclure directement dans une chaîne de
 caractères, et écrire la chaîne <code>&quot;let rec &quot;</code> avant l&apos;identificateur
 et la chaîne <code> =</code> après lui; en revanche, l&apos;espace qui suit le
 caractère <code>=</code> doit être une indication de coupure, puisqu&apos;il est
 d&apos;usage (et élégant) de couper la ligne à cet endroit pour indenter
 la partie expression d&apos;une définition. En conclusion, il est bien
 sûr souvent nécessaire d&apos;imprimer des caractères « espace », ou
 blancs insécables, mais la plupart du temps un espace correspond
 plutôt à une indication de coupure.)</p>
</li>
  <li><p>Ne forcez jamais de coupures de ligne, laissez le moteur
 d&apos;impression le faire pour vous: c&apos;est son travail! En particulier,
 n&apos;utilisez pas la procédure <code>force_newline</code>: son usage provoque bien
 une coupure de ligne, mais il provoque aussi une réinitialisation
 partielle du moteur d&apos;impression qui déséquilibre tout le reste de
 l&apos;impression.</p>
</li>
  <li><p>N&apos;imprimez jamais de retour à la ligne dans les chaînes de
 caractères : le moteur d&apos;impression considèrera à juste titre ce
 retour chariot comme un caractère quelconque émis sur la ligne
 courante, ce qui dérangera complètement la sortie. Utilisez à la
 place des coupures de ligne: si celles-ci doivent se produire à tout
 coup, c&apos;est que la boîte englobante doit être une boîte verticale!</p>
</li>
  <li><p>Terminez votre programme principal d&apos;impression par un appel à
 <code>print_newline ()</code>, qui vide les tables de l&apos;imprimeur (et donc
 termine l&apos;impression). (Notez que le système interactif le fait
 également à la fin de chaque phrase entrée.)</p>
</li>
 </ol>

<h2 id="Impressionsurlasortiestandardutilisationdeprintf">Impression sur la sortie standard: utilisation de <code>printf</code></h2>
<p>Le module <code>format</code> vous propose une fonction générale de formattage à la
<code>printf</code>. En plus des indications de format habituelles à la primitive
<code>printf</code>, on dispose dans le format de caractères qui commandent
ouvertures et fermetures de boîtes ainsi que l&apos;émission d&apos;indications de
coupure de ligne.</p>
<p>Les indications spécifiques au moteur d&apos;impression sont toutes
introduites par le caractère <code>@</code>. À peu près toutes les fonctions du
module <code>format</code> peuvent être appelées depuis un format de <code>printf</code>.
Ainsi :</p>

 <ul>
  <li><p>« <code>@[</code> » ouvre une boîte (<code>open_box             0</code>). On peut
 préciser le type de la boîte en argument supplémentaire. Par exemple
 <code>@[&lt;hov n&gt;</code> est équivalent à <code>open_hovbox n</code>.</p>
</li>
  <li><p>« <code>@]</code> » ferme la dernière boîte ouverte (<code>close_box ()</code>).</p>
</li>
  <li><p>« <code>@</code> » émet un espace sécable (<code>print_space ()</code>).</p>
</li>
  <li><p>« <code>@,</code> » émet une indication de coupure sans espace ni indentation
 supplémentaire en cas de coupure (<code>print_cut ()</code>).</p>
</li>
  <li><p>« <code>@;&lt;n m&gt;</code> » émet une indication de coupure la plus générale, avec
 ses deux arguments entiers (<code>print_break n m</code>).</p>
</li>
  <li><p>« <code>@.</code> » termine l&apos;impression en fermant toutes les boîtes encore
 ouvertes (<code>print_newline ()</code>).</p>
<p>Par exemple
printf &quot;@[&lt;1&gt;%s@ =@ %d@ %s@]@.&quot; &quot;Prix TTC&quot; 100 &quot;Euros&quot;;;
Prix TTC = 100 </p>

   <ul>
    <li><p>: unit = ()</p>
</li>
   </ul>
</li>
 </ul>

<h2 id="Unexempleconcret">Un exemple concret</h2>
<p>Voici un exemple complet : le plus petit exemple non trivial qu&apos;on
puisse imaginer, c&apos;est-à-dire le &#92;$&#92;lambda-&#92;$calculus :)</p>
<p>Le problème est donc d&apos;imprimer les valeurs d&apos;un type concret qui
modélise un langage d&apos;expressions qui définissent les fonctions et leur
application à des arguments.</p>
<p>D&apos;abord, je donne la syntaxe abstraite des lambda-termes (nous utilisons
le <a href='../description.html#interactive'>système interactif</a> pour évaluer ce
code) :</p>
<pre><code>  type lambda =
    | Lambda of string * lambda
    | Var of string
    | Apply of lambda * lambda</code></pre>
<p>J&apos;utilise le module format pour imprimer les lambda-termes:</p>
<pre><code>  open Format;;

  let ident = print_string
  let kwd = print_string;;

  let rec print_exp0 = function
    | Var s -&gt;  ident s
    | lam -&gt; open_hovbox 1; kwd &quot;(&quot;; print_lambda lam; kwd &quot;)&quot;; close_box ()
  and print_app = function
    | e -&gt; open_hovbox 2; print_other_applications e; close_box ()
  and print_other_applications f =
    match f with
    | Apply (f, arg) -&gt; print_app f; print_space (); print_exp0 arg
    | f -&gt; print_exp0 f
  and print_lambda = function
    | Lambda (s, lam) -&gt;
        open_hovbox 1;
        kwd &quot;&#92;&#92;&quot;; ident s; kwd &quot;.&quot;; print_space(); print_lambda lam;
        close_box()
    | e -&gt; print_app e</code></pre>
<p>En Caml Light, remplacez la première ligne par :</p>
<pre><code>#open &quot;format&quot;;;</code></pre>
<h3 id="Impressionlaplusgnraleutilisationdefprintf"> Impression la plus générale: utilisation de <code>fprintf</code></h3>
<p>On utilise maintenant la fonction <code>fprintf</code> et toutes les fonctions
d&apos;impression prennent en argument supplémentaire le formatteur (c&apos;est
l&apos;argument <code>ppf</code>) où l&apos;impression se produira. Cela généralise les
fonctions d&apos;impression qui peuvent maintenant imprimer sur n&apos;importe
quel formateur défini dans le programme, et cela permet en outre
d&apos;utiliser la conversion <code>%a</code>, celle qu&apos;on utilise pour imprimer un
argument de <code>fprintf</code> avec une fonction d&apos;impression spécialisée qu&apos;on a
préalablement définie dans le programme (ces fonctions d&apos;impression de
l&apos;utilisateur prennent aussi un formatteur en premier argument).</p>
<p>Voici la fonction d&apos;impression des lambda-termes à l&apos;aide des formats
d&apos;impression à la <code>fprintf</code>.</p>
<pre><code>  open Format;;

  let ident ppf s = fprintf ppf &quot;%s&quot; s
  let kwd ppf s = fprintf ppf &quot;%s&quot; s;;

  let rec pr_exp0 ppf = function
    | Var s -&gt; fprintf ppf &quot;%a&quot; ident s
    | lam -&gt; fprintf ppf &quot;@[&lt;1&gt;(%a)@]&quot; pr_lambda lam
  and pr_app ppf e =
    fprintf ppf &quot;@[&lt;2&gt;%a@]&quot; pr_other_applications e
  and pr_other_applications ppf f =
    match f with
    | Apply (f, arg) -&gt; fprintf ppf &quot;%a@ %a&quot; pr_app f pr_exp0 arg
    | f -&gt; pr_exp0 ppf f
  and pr_lambda ppf = function
    | Lambda (s, lam) -&gt;
       fprintf ppf &quot;@[&lt;1&gt;%a%a%a@ %a@]&quot;
               kwd &quot;&#92;&#92;&quot; ident s kwd &quot;.&quot; pr_lambda lam
    | e -&gt; pr_app ppf e</code></pre>
<p>Armés de ces fonctions d&apos;impression générales, les procédures
d&apos;impression sur la sortie standard ou la sortie d&apos;erreur s&apos;obtiennent
facilement par application partielle:.</p>
<pre><code>  let print_lambda = pr_lambda std_formatter
  let eprint_lambda = pr_lambda err_formatter
</code></pre>

            <footer id="footer" class="navbar navbar-inverse navbar-fixed-bottom">
              <div class="navbar-inner">
                <div class="container-fluid">
                  <ul class="nav pull-right">
                    <li><a href="#">Feedback</a></li>
                    <li><a href="#">Contact us</a></li>
                    <li><a href="#">Find us on GitHub</a></li>
                  </ul>
                </div>
              </div>
            </footer>
            <!-- Load javascript from CDN -->
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
            <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
  </body>
</html>
