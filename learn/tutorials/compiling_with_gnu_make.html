<!DOCTYPE HTML>

<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title> &ndash; OCaml</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Web Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Domine:400,700" rel="stylesheet">
    <!-- Only part of Bootstrap that we don't load from a CDN is our own customized CSS build. -->
    <link href="/static/css/bootstrap.css" rel="stylesheet" media="screen">
    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <![endif]-->
    <script type="text/javascript">
      function octry(x){
      if(document.getElementById('buttons').innerHTML=='') {
      t = document.getElementById('tryocaml');
      js = document.createElement("script"); js.type = "text/javascript"; js.src = "/try-ocaml.js";
      t.appendChild(js);
      } else {
      t = document.getElementById('tryocaml');
      t.style.display = 'block';
      p=document.getElementsByTagName('pre')
      for(i=0;p[i];i++){
      p.onClick=function () {}
      }
      p=document.getElementsByTagName('code')
      for(i=0;p[i];i++){
      p.onClick=function () {}
      }
      document.getElementById('console').value = x;
      document.getElementById('console').focus();
      document.getElementById('console').select();
      }
      }
    </script>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/"><img src="/static/img/ocaml.png" alt="OCaml"></a>
          <div class="nav-collapse collapse">
                        <ul class="nav">
              <li ><a href="/learn/">Learn</a></li>
              <li ><a href="/docs/">Documentation</a></li>
              <li ><a href="/platform/">Platform</a></li>
              <li ><a href="/list.html">Packages</a></li>
              <li ><a href="/community/">Community</a></li>
            </ul>

            <form class="navbar-search pull-right">
              <input class="search-query" type="text" placeholder="Search" />
            </form>
          </div>
        </div>
      </div>
    </nav>
    
        <div class="container">
      <div class="row">

        <div id="content-primary" class="span8">
    <div id='tryocaml' class="content" style='display:none;'>
      <div class="container">
        <div class="row">
          <div id="lesson-message"></div>
          <div id="languages" style='display:none;'></div>
          <div id="menu-lessons" style='display:none'>
            <table class="zebra-striped">
              <tr><td id="text-x"><code></code></td> <td id=""></td></tr>
            </table>
          </div>
          <div class="span9 ocaml">
            <div id="toplevel-container">
              <pre id="output"></pre>
              <div id="sharp">#</div>
              <div id="toplevel"></div>
            </div>
            <div id="buttons"></div>
            <div id="graphics-title"></div>
            <div id="graphics"></div>
          </div>
        </div>
      </div>
    </div>

          <div id='main-contents' class="content">
            <h1 id="CompilingwithGNUmake"> Compiling with GNU make</h1><h2 id="UsingGNUmakewithOCamlMakefile"> Using GNU make with OCamlMakefile</h2><p>

<a href='http://omake.metaprl.org/index.html' title='OCamlMakefile'>OCamlMakefile</a> is
a generic Makefile that greatly facilitates the process of compiling
complex OCaml projects.</p>
<p>For a basic OCaml program or library that doesn&#39;t use any library
besides the standard library, just copy OCamlMakefile to the current
directory and create the following Makefile:</p>
<pre class='ocaml'>RESULT <span class='k'>=</span> myprogram
SOURCES <span class='k'>=</span> <span class='o'>\</span>
  mymodule1<span class='o'>.</span>mli mymodule1<span class='o'>.</span>ml <span class='o'>\</span>
  myparser<span class='o'>.</span>mli myparser<span class='o'>.</span>mly mylexer<span class='o'>.</span>mll mymodule2<span class='o'>.</span>ml <span class='o'>\</span>
  mymainprogram<span class='o'>.</span>ml

OCAMLMAKEFILE <span class='k'>=</span> OCamlMakefile
<span class='k'>include</span> <span class='o'>$</span>(OCAMLMAKEFILE)
<a href="javascript:octry('RESULT = myprogram\nSOURCES = \\n  mymodule1.mli mymodule1.ml \\n  myparser.mli myparser.mly mylexer.mll mymodule2.ml \\n  mymainprogram.ml\n\nOCAMLMAKEFILE = OCamlMakefile\ninclude $(OCAMLMAKEFILE)\n');">[try]</a></pre>
<p>
This is already a fairly complex program which has 5 compilation units
and uses ocamlyacc and ocamllex. Only the source files must be given,
except for the .mli files that are produced by ocamlyacc, myparser.mli
in the example.</p>
<p>The included OCamlMakefile provides a variety of targets. For details
please refer to the documentation of OCamlMakefile, but here are the
main ones:</p>
<pre class='ocaml'>nc     make a native code executable
bc     make a bytecode executable
ncl    make a native code library
bcl    make a bytecode library
libinstall    install library <span class='k'>with</span> ocamlfind
libuninstall  uninstall library <span class='k'>with</span> ocamlfind
top    make a custom toplevel from all your modules
clean  remove everything that matches one <span class='k'>of</span> the files that could have been
       automatically created by OCamlMakefile
<a href="javascript:octry('nc     make a native code executable\nbc     make a bytecode executable\nncl    make a native code library\nbcl    make a bytecode library\nlibinstall    install library with ocamlfind\nlibuninstall  uninstall library with ocamlfind\ntop    make a custom toplevel from all your modules\nclean  remove everything that matches one of the files that could have been\n       automatically created by OCamlMakefile\n');">[try]</a></pre>
<h2 id="OCamlMakefilelibrariesCamlp4parsing"> OCamlMakefile + libraries + Camlp4 parsing</h2><p>

The recommended tool for installing OCaml libraries is
<a href='http://www.camlcity.org/archive/programming/findlib.html' title='Findlib'>Findlib</a>
(ocamlfind command) since it knows where packages are installed, loads
their dependencies and knows which file should be used in a given
situation.</p>
<p>If you do not use Findlib, loading a regular runtime library can be done
by setting the LIBS and INCDIRS variable. LIBS is the list of the name
of the library files (xxx.cma or xxx.cmxa) without the .cma or .cmxa
extension:</p>
<pre class='ocaml'>LIBS <span class='k'>=</span> str unix
<a href="javascript:octry('LIBS = str unix\n');">[try]</a></pre>
<p>
If you use non-standard libraries that are not installed in the same
directory as the standard library, the INCDIRS variable must contain the
list of these directories:</p>
<pre class='ocaml'>INCDIRS <span class='k'>=</span> <span class='o'>/</span>path<span class='o'>/</span><span class='k'>to</span><span class='o'>/</span>somelibdirectory<span class='o'>/</span>
<a href="javascript:octry('INCDIRS = /path/to/somelibdirectory/\n');">[try]</a></pre>
<p>
Usually this requires some preliminary configuration as it is
traditionally performed with a configure script since the path can vary
from one installation to another. An exception is when using standard
directories which are not included in the search path by default such as
/path/to/stdlib/camlp4. In this case, this should be enough and
portable:</p>
<pre class='ocaml'>INCDIRS <span class='k'>=</span> <span class='o'>+</span>camlp4
<a href="javascript:octry('INCDIRS = +camlp4\n');">[try]</a></pre>
<p>
OK, but we prefer libraries that are installed with ocamlfind. To use
them with OCamlMakefile, the PACKS variable must be set:</p>
<pre class='ocaml'>PACKS <span class='k'>=</span> netstring num
<a href="javascript:octry('PACKS = netstring num\n');">[try]</a></pre>
<p>
Note that libraries that not part of the standard library but are
shipped with any standard OCaml installation such as unix, str or
bigarray are automatically considered as Findlib packages. Any package
which is required by a given package (e.g. netstring requires unix and
pcre) is automatically loaded.</p>
<p>How about Camlp4 syntax extensions? Some packages may define syntax
extensions, which are bytecode units that are loaded by the
preprocessor. With OCamlMakefile, a preprocessor to be used can be
defined in the first line of the file:</p>
<pre class='ocaml'><span class='com2'>(*pp <span class='ic'>...</span></span>
<span class='com2'></span><a href="javascript:octry('(*pp ...\n');">[try]</a></pre>
<p>
So it could be something like:</p>
<pre class='ocaml'><span class='com2'>(*pp camlp4o <span class='ic'>-</span>I <span class='ic'>/</span>path<span class='ic'>/</span><span class='ic'>to</span><span class='ic'>/</span>pa_infix pa_infix<span class='ic'>.</span>cmo *)</span><!-- end comment -->
<a href="javascript:octry('(*pp camlp4o -I /path/to/pa_infix pa_infix.cmo *)\n');">[try]</a></pre>
<p>
Well, this form is not very convenient, so we will use the same
preprocessor for each file and store its value in the PP variable of the
Makefile:</p>
<pre class='ocaml'>PP <span class='k'>=</span> camlp4o <span class='o'>-</span>I <span class='o'>/</span>path<span class='o'>/</span><span class='k'>to</span><span class='o'>/</span>pa_infix pa_infix<span class='o'>.</span>cmo
export PP
<a href="javascript:octry('PP = camlp4o -I /path/to/pa_infix pa_infix.cmo\nexport PP\n');">[try]</a></pre>
<p>
So each OCaml file will start with:</p>
<pre class='ocaml'><span class='com2'>(*pp <span class='ic'>$</span>PP *)</span><!-- end comment -->
<a href="javascript:octry('(*pp $PP *)\n');">[try]</a></pre>
<p>
This way of defining the preprocessor is still not satisfying: we would
like to take advantage of ocamlfind to load the appropriate syntax
extension files. For this, we will use the <a href='http://martin.jambon.free.fr/ocaml.html' title='camlp4find script'>camlp4find
script</a>.
Every package which we use will listed as usual in the PACKS variable,
and camlp4find will call ocamlfind to know which syntax extensions to
load:</p>
<pre class='ocaml'>PACKS <span class='k'>=</span> unix micmatch_pcre <span class='o'>\</span>
   pa_tryfinally pa_lettry pa_forin pa_forstep pa_repeat pa_arg
PP <span class='k'>=</span> camlp4find <span class='o'>$</span>(PACKS)
export PP
<a href="javascript:octry('PACKS = unix micmatch_pcre \\n   pa_tryfinally pa_lettry pa_forin pa_forstep pa_repeat pa_arg\nPP = camlp4find $(PACKS)\nexport PP\n');">[try]</a></pre>
<p>
<strong>Summary:</strong></p>
<p>You need:</p>
<ul>
 <li>GNU make
 </li>
 <li>OCamlMakefile (copied to the project&#39;s main directory)
 </li>
 <li>Findlib (ocamlfind)
 </li>
 <li>camlp4find (copied to the project&#39;s main directory)
 </li>
 <li>Camlp4 packages installed with ocamlfind
 </li>
 <li>write a small Makefile according to the template below
 </li>
 <li>add a constant magic line at the beginning of your source files</li>
</ul>

<p>Full example using ocamllex and the unix and micmatch_pcre libraries.
The Makefile file would be:</p>
<pre class='ocaml'>RESULT <span class='k'>=</span> myprogram
SOURCES <span class='k'>=</span> mymodule1<span class='o'>.</span>mll mymodule2<span class='o'>.</span>mli mymodule2<span class='o'>.</span>ml mymainmodule<span class='o'>.</span>ml
PACKS <span class='k'>=</span> unix micmatch_pcre
PP <span class='k'>=</span> camlp4find <span class='o'>$</span>(PACKS)
export PP
CREATE_LIB <span class='k'>=</span> yes <span class='o'>#</span> <span class='o'>???</span>
OCAMLMAKEFILE <span class='k'>=</span> OCamlMakefile
<span class='k'>include</span> <span class='o'>$</span>(OCAMLMAKEFILE)
<a href="javascript:octry('RESULT = myprogram\nSOURCES = mymodule1.mll mymodule2.mli mymodule2.ml mymainmodule.ml\nPACKS = unix micmatch_pcre\nPP = camlp4find $(PACKS)\nexport PP\nCREATE_LIB = yes # ???\nOCAMLMAKEFILE = OCamlMakefile\ninclude $(OCAMLMAKEFILE)\n');">[try]</a></pre>
<p>
And each .ml or .mli file starts with:</p>
<pre class='ocaml'><span class='com2'>(*pp <span class='ic'>$</span>PP *)</span><!-- end comment -->

<a href="javascript:octry('(*pp $PP *)\n\n');">[try]</a></pre>

          </div>
        </div>
      </div>
    </div>
    <footer id="footer" class="navbar navbar-inverse navbar-fixed-bottom">
      <div class="navbar-inner">
        <div class="container-fluid">
          <ul class="nav pull-right">
            <li><a href="#">Feedback</a></li>
            <li><a href="#">Contact us</a></li>
            <li><a href="#">Find us on GitHub</a></li>
          </ul>
        </div>
      </div>
    </footer>
    <!-- Load javascript from CDN -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <script>octry('')</script>
  </body>
</html>
